# Диагностика SMTP сервера

## Быстрая проверка

### 1. Проверьте, запущен ли SMTP сервер

```bash
# Проверьте логи при запуске сервера
# Должны быть строки:
# "SMTP-сервер запущен на порту 2525"
# "Домен: tempmail.dev"
```

### 2. Проверьте, слушает ли сервер порт

**Windows:**
```powershell
netstat -an | findstr :2525
```

**Linux/Mac:**
```bash
netstat -an | grep 2525
# или
lsof -i :2525
```

Если порт не слушается - сервер не запущен или запущен на другом порту.

### 3. Проверьте конфигурацию

Убедитесь, что переменные окружения установлены правильно:

```bash
# Проверьте .env файл или переменные окружения
SMTP_PORT=2525
MAIL_DOMAIN=tempmail.dev  # или ваш домен
```

### 4. Тест локального подключения

Используйте скрипт для тестирования:

```bash
cd server
go run scripts/test-smtp.go localhost 2525 ваш-ящик@tempmail.dev
```

Или используйте telnet:

```bash
telnet localhost 2525
```

В telnet выполните:
```
EHLO test
MAIL FROM:<test@example.com>
RCPT TO:<ваш-ящик@tempmail.dev>
DATA
Subject: Test

Тестовое письмо
.
QUIT
```

### 5. Проверьте логи сервера

При отправке письма в логах должны появиться:
- "Новое SMTP-соединение от ..."
- "MAIL FROM: ..."
- "RCPT TO: ..."
- "Получение данных письма..."
- "Письмо от ..., тема: ..."

## Проблемы и решения

### Проблема: Письма не приходят из интернета

**Причина:** SMTP сервер работает только локально. Для получения писем из интернета нужно:

1. **Настроить DNS записи:**
   - MX запись: указывает на ваш сервер
   - A запись: IP адрес вашего сервера
   - SPF запись: разрешает отправку с вашего сервера
   - DKIM запись: для аутентификации (опционально)

2. **Открыть порт 25:**
   - В файрволе сервера
   - В настройках хостинга/VPS
   - Многие провайдеры блокируют порт 25 - используйте порт 587 или 465 с TLS

3. **Изменить порт на 25:**
   ```bash
   SMTP_PORT=25
   ```

### Проблема: "Почтовый ящик не найден"

**Проверьте:**
1. Ящик создан через API
2. Домен в адресе ящика совпадает с `MAIL_DOMAIN`
3. Ящик не истёк (проверьте `expires_at`)

**Решение:**
```bash
# Проверьте ящик через API
curl http://localhost:8080/api/v1/mailbox/{id}
```

### Проблема: Ошибка подключения к SMTP

**Возможные причины:**
1. Сервер не запущен
2. Неправильный порт
3. Файрвол блокирует порт
4. Сервер слушает только localhost (127.0.0.1), а не 0.0.0.0

**Решение:**
- Проверьте, что сервер запущен: `go run cmd/api/main.go`
- Проверьте порт в конфигурации
- Для доступа извне сервер должен слушать `0.0.0.0`, а не `localhost`

### Проблема: Письма не сохраняются в БД

**Проверьте:**
1. Логи сервера на наличие ошибок
2. Подключение к базе данных
3. Права доступа к БД

**Решение:**
```bash
# Проверьте подключение к БД
psql -h localhost -U postgres -d tempmail

# Проверьте таблицы
\dt

# Проверьте письма
SELECT * FROM messages ORDER BY received_at DESC LIMIT 10;
```

## Проверка через API

### 1. Создайте ящик
```bash
curl -X POST http://localhost:8080/api/v1/mailbox
```

### 2. Получите список писем
```bash
curl http://localhost:8080/api/v1/mailbox/{id}/messages
```

### 3. Проверьте статистику
```bash
curl http://localhost:8080/stats
```

## Тестирование с внешних сервисов

### Gmail, Outlook и другие

Для получения писем от внешних сервисов (Gmail, Outlook и т.д.) нужно:

1. **Настроить DNS:**
   ```
   MX запись: mail.yourdomain.com (приоритет 10)
   A запись: mail.yourdomain.com -> ваш IP
   ```

2. **Открыть порт 25** на сервере

3. **Настроить домен:**
   ```bash
   MAIL_DOMAIN=yourdomain.com
   ```

4. **Проверить SPF:**
   ```
   TXT запись: v=spf1 ip4:ваш-IP ~all
   ```

### Локальное тестирование

Для локального тестирования используйте:
- `localhost` или `127.0.0.1` как хост
- Порт `2525` (нестандартный, не требует root прав)
- Тестовый скрипт из `scripts/test-smtp.go`

## Мониторинг

### Проверка активности SMTP

Добавьте в код логирование всех соединений (уже есть в `backend.go`):
```go
log.Printf("Новое SMTP-соединение от %s", c.Hostname())
```

### Проверка базы данных

```sql
-- Количество писем
SELECT COUNT(*) FROM messages;

-- Последние письма
SELECT id, from_address, subject, received_at 
FROM messages 
ORDER BY received_at DESC 
LIMIT 10;

-- Письма по ящику
SELECT * FROM messages WHERE mailbox_id = 'ваш-id';
```

## Полезные команды

```bash
# Проверка портов
netstat -tulpn | grep 2525

# Проверка процессов
ps aux | grep tempmail

# Логи Docker (если используете)
docker logs tempmail-server

# Тест SMTP через telnet
telnet localhost 2525

# Тест через curl (только для HTTP API)
curl http://localhost:8080/health
```

